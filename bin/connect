#!/bin/bash

connect_main(){
  local interface_name=$1; shift
  if [ -z "$interface_name" ]; then
    echo "usage: connect <INTERFACE_NAME> <USER_NAME>"
    exit 1
  fi

  local ip=$(ip addr show $interface_name | grep "inet " | awk '{ print $2 }' | sed 's|/.*||')
  if [ -z "$ip" ]; then
    echo "[FAILED] detect local ip address"
    exit 1
  fi

  local user=$1; shift
  if [ -z "$user" ]; then
    echo "usage: connect <INTERFACE_NAME> <USER_NAME>"
    exit 1
  fi

  local skip_update

  if [ -n "$SKIP_UPDATE" ]; then
    skip_update=true
  fi

  local timezone=Asia/Tokyo
  local image=getto/base:k2JmDVzT
  local home=/home/$user
  local name=getto-labo
  local base

  if [ -z "$skip_update" ]; then
    for base in $(docker image ls --format="{{.Repository}}:{{.Tag}}" | grep getto/base | grep -v none); do
      docker pull $base
    done

    if [ -n "$(docker image ls --format="{{.Repository}}:{{.Tag}}" | grep getto/base | grep none)" ]; then
      docker image rm $(docker image ls --format="{{.Repository}}:{{.Tag}} {{.ID}}" | grep getto/base | grep none | awk '{ print $2 }')
    fi
  fi

  if [ "$(connect_container_exists)" ]; then
    docker attach $name \
      --detach-keys ctrl-@,ctrl-@ \
    ;
  else
    if [ "$(connect_container_exists -a)" ]; then
      docker rm $name
    fi
    docker run -it --rm \
      --detach-keys ctrl-@,ctrl-@ \
      --name $name \
      -e DOCKER_WRAPPER_VOLUMES=$HOME/volumes/apps:/apps,$HOME/volumes/home:/home \
      -e LABO_IP=$ip \
      -e LABO_USER=$user \
      -e LABO_TIMEZONE=$timezone \
      -v $HOME/volumes/apps:/apps \
      -v $HOME/volumes/home:/home \
      -v /var/run/docker.sock:/var/run/docker.sock \
      -w $home \
      $image
  fi
}
connect_container_exists(){
  docker ps "$@" -f name=$name --format '{{.ID}} {{.Names}}' | grep $name'$'
}

connect_main "$@"
